class i{cache=new Map;loadQueue=[];isProcessing=!1;BATCH_SIZE=50;BATCH_DELAY=16;getSync(e){return this.cache.has(e)?this.cache.get(e):{enabled:!0}}getSyncWithStorage(e){if(this.cache.has(e))return this.cache.get(e);if(typeof window<"u")try{const a=localStorage.getItem(`rule-${e}`);if(a){const s=JSON.parse(a);return this.cache.set(e,s),s}}catch(a){console.error(`Failed to load ${e}:`,a)}const t={enabled:!0};return this.cache.set(e,t),t}async load(e,t){if(this.cache.has(e)){t(this.cache.get(e));return}this.loadQueue.push({ruleCode:e,callback:t}),this.isProcessing||this.processBatch()}processBatch(){if(this.loadQueue.length===0){this.isProcessing=!1;return}this.isProcessing=!0,requestAnimationFrame(()=>{const e=this.loadQueue.splice(0,this.BATCH_SIZE);for(const{ruleCode:t,callback:a}of e){let s;if(typeof window<"u")try{const c=localStorage.getItem(`rule-${t}`);c?(s=JSON.parse(c),this.cache.set(t,s)):(s={enabled:!0},this.cache.set(t,s))}catch(c){console.error(`Failed to load ${t}:`,c),s={enabled:!0},this.cache.set(t,s)}else s={enabled:!0};a(s)}this.loadQueue.length>0?setTimeout(()=>this.processBatch(),this.BATCH_DELAY):this.isProcessing=!1})}set(e,t){this.cache.set(e,t),typeof window<"u"&&localStorage.setItem(`rule-${e}`,JSON.stringify(t))}clearAll(){if(this.cache.clear(),this.loadQueue=[],this.isProcessing=!1,typeof window<"u")try{Object.keys(localStorage).filter(t=>t.startsWith("rule-")).forEach(t=>localStorage.removeItem(t))}catch(e){console.error("Failed to clear localStorage:",e)}}}const o=new i;export{o as r};
